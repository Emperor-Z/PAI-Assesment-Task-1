{% extends "base.html" %}
{% block content %}
<h1>Genre deep dive</h1>
<section class="hero-panel">
  <p>
    Compare a single favourite genre against the overall cleaned cohort. Use the deltas below to
    explain how respondents who prefer that genre report anxiety, depression, insomnia, and OCD scores.
  </p>
  {% if genre_options|length <= 1 %}
  <p class="warning">
    Only {{ genre_options|length }} distinct genre recorded in the filtered dataset. This is usually due
    to tight filters or small cohorts—clear filters or lower min_n to unlock more comparisons.
  </p>
  {% else %}
  <p>{{ genre_options|length }} genres currently satisfy the filters.</p>
  {% endif %}
</section>

<form method="get" class="filter-form">
  <div class="filter-grid">
    <label for="genre">Genre</label>
    <select id="genre" name="genre">
      <option value="">Select a genre</option>
      {% for genre in genre_options %}
      <option value="{{ genre }}" {% if genre == selected_genre %}selected{% endif %}>{{ genre }}</option>
      {% endfor %}
    </select>

    <label for="metric">Score</label>
    <select id="metric" name="metric">
      {% for key, label in metric_labels %}
      <option value="{{ key }}" {% if key == selected_metric %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>

    <label for="min_n">Group minimum (min_n)</label>
    <select id="min_n" name="min_n">
      {% for option in min_n_options %}
      <option value="{{ option }}" {% if option == selected_min_n %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-actions">
    <button type="submit">View insights</button>
    <a class="link-button" href="{{ url_for('genre_insights') }}">Clear</a>
  </div>
</form>

{% if selected_genre %}
  {% if stats_entry %}
    <section class="stat-card">
      <h2>{{ selected_genre }} respondents</h2>
      <p>Respondents: {{ stats_entry.n }}</p>
      <ul>
        <li>Anxiety mean: {{ "%.1f"|format(stats_entry.anxiety_mean) }} (Δ {{ "%.1f"|format(deltas.anxiety) }})</li>
        <li>Depression mean: {{ "%.1f"|format(stats_entry.depression_mean) }} (Δ {{ "%.1f"|format(deltas.depression) }})</li>
        <li>Insomnia mean: {{ "%.1f"|format(stats_entry.insomnia_mean) }} (Δ {{ "%.1f"|format(deltas.insomnia) }})</li>
        <li>OCD mean: {{ "%.1f"|format(stats_entry.ocd_mean) }} (Δ {{ "%.1f"|format(deltas.ocd) }})</li>
      </ul>
      {% if warning_message %}
      <p class="warning">{{ warning_message }}</p>
      {% endif %}
    </section>

    <section class="chart-card">
      <h3>{{ metric_lookup[selected_metric] }} distribution ({{ selected_genre }})</h3>
      {% if chart_url %}
      <img src="{{ chart_url }}" alt="Genre distribution chart" />
      {% else %}
      <p class="no-data">Distribution chart unavailable for this selection, but the summary above still applies.</p>
      {% endif %}
    </section>
  {% else %}
    <p class="no-data">No respondents recorded for {{ selected_genre }}.</p>
  {% endif %}
{% else %}
  <section class="stat-card">
    <h2>Overall averages</h2>
    <p>Select a genre to view mental health statistics and score distributions.</p>
    <ul>
      <li>Anxiety mean: {{ "%.1f"|format(overall_means.get("anxiety", 0)) }}</li>
      <li>Depression mean: {{ "%.1f"|format(overall_means.get("depression", 0)) }}</li>
      <li>Insomnia mean: {{ "%.1f"|format(overall_means.get("insomnia", 0)) }}</li>
      <li>OCD mean: {{ "%.1f"|format(overall_means.get("ocd", 0)) }}</li>
    </ul>
  </section>
{% endif %}
{% endblock %}
